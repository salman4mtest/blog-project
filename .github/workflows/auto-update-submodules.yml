name: Auto Update Submodules

on:
  repository_dispatch:
    types: 
      - update-ecommerce-shopcart-service
  workflow_dispatch:
      
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.MAIN_REPO_PAT }}
          # Don't checkout submodules automatically - we'll do it manually
          
      - name: Initialize and update submodule
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          echo "🔄 Initializing submodules..."
          git submodule init
          
          echo "📊 Current submodule status BEFORE update:"
          git submodule status
          
          echo ""
          echo "📥 Fetching latest from shopcart repo..."
          cd ecommerce-shopcart-service
          git fetch origin main
          
          echo ""
          echo "📍 Current commit in submodule:"
          git rev-parse HEAD
          
          echo ""
          echo "📍 Latest commit in origin/main:"
          git rev-parse origin/main
          
          echo ""
          echo "🔀 Checking out latest commit..."
          git checkout origin/main
          
          cd ..
          
          echo ""
          echo "📊 Submodule status AFTER checkout:"
          git submodule status
          
          echo ""
          echo "🔍 Checking if main repo has changes..."
          git status
          git diff --cached ecommerce-shopcart-service
          
          # Check if the submodule pointer changed
          if [[ -n $(git status --porcelain ecommerce-shopcart-service) ]]; then
            echo ""
            echo "✅ Submodule pointer changed! Committing..."
            
            git add ecommerce-shopcart-service
            git commit -m "🤖 Auto-update: shopcart service - Triggered by ${{ github.event.client_payload.ref }} - SHA: ${{ github.event.client_payload.sha }}"
            
            echo "⬆️ Pushing to main repo..."
            git push origin main
            
            echo "✅ Shopcart submodule updated successfully!"
            echo "📝 Main repo now points to latest shopcart commit"
          else
            echo ""
            echo "ℹ️ No changes detected in submodule pointer"
            echo "This could mean:"
            echo "  - The submodule was already at the latest commit"
            echo "  - OR the checkout didn't work as expected"
          fi
          
      - name: Show final submodule status
        if: always()
        run: |
          echo "📊 Final submodule status:"
          git submodule status
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ Failed to update shopcart submodule"
          echo "Check the error messages above for details"