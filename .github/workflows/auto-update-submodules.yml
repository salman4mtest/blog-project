name: Auto Update Submodules

on:
  repository_dispatch:
    types: 
      - update-ecommerce-shopcart-service
  workflow_dispatch:
      
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.MAIN_REPO_PAT }}
          # Don't checkout submodules automatically - we'll do it manually
          
      - name: Initialize and update submodule
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          echo "üîÑ Initializing submodules..."
          git submodule init
          
          echo "üì• Updating shopcart submodule to latest..."
          # This fetches and checks out the latest commit from the submodule's main branch
          git submodule update --remote --force ecommerce-shopcart-service
          
          echo "üîç Checking for changes..."
          git status
          
          # Check if the submodule pointer changed
          if [[ -n $(git status --porcelain ecommerce-shopcart-service) ]]; then
            echo "‚úÖ Submodule updated! Committing changes..."
            
            git add ecommerce-shopcart-service
            git commit -m "ü§ñ Auto-update: shopcart service - Triggered by ${{ github.event.client_payload.ref }} - SHA: ${{ github.event.client_payload.sha }}"
            
            echo "‚¨ÜÔ∏è Pushing to main repo..."
            git push origin main
            
            echo "‚úÖ Shopcart submodule updated successfully!"
            echo "üìù Main repo now points to latest shopcart commit"
          else
            echo "‚ÑπÔ∏è No updates needed - submodule already at latest version"
          fi
          
      - name: Show final submodule status
        if: always()
        run: |
          echo "üìä Final submodule status:"
          git submodule status
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Failed to update shopcart submodule"
          echo "Check the error messages above for details"