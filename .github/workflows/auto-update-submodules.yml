name: Auto Update Submodules

on:
  repository_dispatch:
    types: 
      - update-ecommerce-shopcart-service
  workflow_dispatch:
      
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.MAIN_REPO_PAT }}
          fetch-depth: 0  # Get full history
          
      - name: Configure Git authentication
        run: |
          # Configure Git to use the PAT token for authentication
          git config --global url."https://x-access-token:${{ secrets.MAIN_REPO_PAT }}@github.com/".insteadOf "https://github.com/"
          
      - name: Initialize and update submodule
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          echo "üîÑ Syncing submodule configuration..."
          git submodule sync --recursive
          
          echo "üîÑ Initializing submodules..."
          git submodule init
          
          echo "üìä Current submodule status BEFORE update:"
          git submodule status
          
          echo ""
          echo "üîß Checking submodule remote URL..."
          cd ecommerce-shopcart-service
          echo "Remote URL:"
          git remote -v
          
          echo ""
          echo "üì• Fetching latest from shopcart repo..."
          git fetch origin main --verbose
          
          echo ""
          echo "üìç Current commit in submodule:"
          CURRENT_COMMIT=$(git rev-parse HEAD)
          echo $CURRENT_COMMIT
          
          echo ""
          echo "üìç Latest commit in origin/main:"
          LATEST_COMMIT=$(git rev-parse origin/main)
          echo $LATEST_COMMIT
          
          if [ "$CURRENT_COMMIT" = "$LATEST_COMMIT" ]; then
            echo ""
            echo "‚ÑπÔ∏è Submodule is already at latest commit"
            echo "No update needed"
            cd ..
            exit 0
          fi
          
          echo ""
          echo "üîÄ Checking out latest commit..."
          git checkout origin/main
          
          cd ..
          
          echo ""
          echo "üìä Submodule status AFTER checkout:"
          git submodule status
          
          echo ""
          echo "üîç Checking if main repo has changes..."
          git status
          
          # Check if the submodule pointer changed
          if [[ -n $(git status --porcelain ecommerce-shopcart-service) ]]; then
            echo ""
            echo "‚úÖ Submodule pointer changed! Committing..."
            
            git add ecommerce-shopcart-service
            git commit -m "ü§ñ Auto-update: shopcart service - SHA: ${{ github.event.client_payload.sha }}"
            
            echo "‚¨ÜÔ∏è Pulling latest changes first..."
            git pull --rebase origin main || git pull origin main
            
            echo "‚¨ÜÔ∏è Pushing to main repo..."
            git push origin main
            
            echo "‚úÖ Shopcart submodule updated successfully!"
            echo "üìù Main repo now points to commit: $LATEST_COMMIT"
          else
            echo ""
            echo "‚ö†Ô∏è No changes detected in submodule pointer after checkout"
            echo "This shouldn't happen - please check the logs above"
          fi
          
      - name: Show final submodule status
        if: always()
        run: |
          echo "üìä Final submodule status:"
          git submodule status
          
      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Failed to update shopcart submodule"
          echo "Check the error messages above for details"